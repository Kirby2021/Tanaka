const util=require("util"),discord=require("discord.js"),tags=require("common-tags"),{escapeRegex:escapeRegex}=require("../../Structures/Util"),{Command:Command}=require("discord.js-commando"),nl="!!NL!!",nlPattern=new RegExp(nl,"g");module.exports=class EvalCommand extends Command{constructor(e){super(e,{name:"eval",aliases:["debug"],group:"util",memberName:"eval",description:"Executes arbitrary JavaScript code.",details:"Only the bot owner may use this command.",ownerOnly:!0,guarded:!0,args:[{key:"script",prompt:"What code would you like to evaluate?",type:"string"}]}),this.lastResult=null,Object.defineProperty(this,"_sensitivePattern",{value:null,configurable:!0})}run(msg,{script:script}){const{channel:channel,guild:guild,author:author,member:member}=msg,message=msg,{client:client,lastResult:lastResult}=this,doReply=e=>{if(e instanceof Error)msg.reply(`Callback error: \`${e}\``);else{const t=this.makeResultMessages(e,process.hrtime(this.hrStart));if(Array.isArray(t))for(const e of t)msg.reply(e);else msg.reply(t)}};let hrDiff;try{const hrStart=process.hrtime();this.lastResult=eval(script),hrDiff=process.hrtime(hrStart)}catch(e){return msg.reply(`Error while evaluating: \`${e}\``)}this.hrStart=process.hrtime();const result=this.makeResultMessages(this.lastResult,hrDiff,script);return Array.isArray(result)?result.map((e=>msg.reply(e))):msg.reply(result)}makeResultMessages(e,t,s=null){const r=util.inspect(e,{depth:0}).replace(nlPattern,"\n").replace(this.sensitivePattern,"--REDACTED--").replace(process.env.DATABASE_URL,"--REDACTED--").replace(process.env,"--REDACTED--"),a=r.split("\n"),i=r.length-1,n=`\`\`\`javascript\n${"{"!==r[0]&&"["!==r[0]&&"'"!==r[0]?a[0]:r[0]}\n`,l=`\n${"}"!==r[i]&&"]"!==r[i]&&"'"!==r[i]?a[a.length-1]:r[i]}\n\`\`\``;if(s)return discord.splitMessage(tags.stripIndents`
				*Callback executed after ${t[0]>0?`${t[0]}s `:""}${t[1]/1e6}ms.*
				\`\`\`javascript
				${r}
				\`\`\`
			`,{maxLength:1900,prepend:n,append:l})}get sensitivePattern(){if(!this._sensitivePattern){const{client:e}=this;let t="";e.token&&(t+=escapeRegex(e.token)),Object.defineProperty(this,"_sensitivePattern",{value:new RegExp(t,"gi"),configurable:!1})}return this._sensitivePattern}};
//# sourceMappingURL=eval.js.map
