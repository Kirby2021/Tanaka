const{MessageEmbed:MessageEmbed,WebhookClient:WebhookClient}=require("discord.js"),{Client:Client}=require("@2pg/oauth"),express=require("express"),cookies=require("cookies"),helmet=require("helmet"),morgan=require("morgan"),path=require("path"),cors=require("cors"),app=express(),client=new Client({id:process.env.CLIENT_ID,secret:process.env.CLIENT_SECRET,redirectURI:"https://tanaka-bot.me/auth/callback",scopes:["identify"]}),port=process.env.PORT,hook=new WebhookClient(process.env.VOTE_ID,process.env.VOTE_TOKEN);module.exports=e=>{app.use(cors()),app.use(helmet({contentSecurityPolicy:!1,frameguard:!1})),app.use(express.json()),app.use(express.urlencoded({extended:!0})),app.use(express.text()),app.use(cookies.express(["I","store","login","sessions."])),app.use(morgan("combined")),app.use("/static",express.static(path.join(__dirname,"static"))),app.set("view engine","ejs"),app.set("trust proxy",!0),app.set("json spaces",8),app.set("views",path.join(__dirname,"views")),app.get("/",(async(t,o)=>{const s=t.cookies.get("discordToken"),i=(await e.userCount()).toLocaleString(),n=(await e.guildCount()).toLocaleString(),a=(await e.channelCount()).toLocaleString(),r=e.registry.commands.size.toLocaleString(),c=e.shard?e.shard.shardCount.toLocaleString():"1",p=Math.round(e.ws.ping),d=s?await client.getUser(s):null;o.render("index",{data:d,userCount:i,guildCount:n,channelCount:a,commandCount:r,shardCount:c,ping:p})})),app.get("/invite",((e,t)=>t.redirect(302,"https://discord.com/api/oauth2/authorize?client_id=804605929944645672&permissions=641064257&redirect_uri=https%3A%2F%2Ftanaka.1chi.tk%2Fauth%2Fcallback&response_type=code&scope=identify%20bot"))),app.get("/discord",((e,t)=>t.redirect(302,"https://discord.gg/zGvtAnGhdP"))),app.get("/github",((e,t)=>t.redirect(302,"https://github.com/1chiSensei/Tanaka"))),app.get("/commands",(async(t,o)=>{const s=t.cookies.get("discordToken");o.render("commands",{data:s?await client.getUser(s):null,commands:e.generateCommandList()})})),app.get("/legal",(async(e,t)=>{const o=e.cookies.get("discordToken");t.render("legal",{data:o?await client.getUser(o):null})})),app.get("/vote",((e,t)=>t.render("vote"))),app.get("/profile",(async(e,t)=>{const o=e.cookies.get("discordToken");t.render("profile",{data:o?await client.getUser(o):null,moment:require("moment")})})),app.get("/auth/login",((e,t)=>t.redirect(302,client.authCodeLink.url))),app.get("/auth/callback",(async(e,t)=>{if(e.cookies.get("discordToken"))return t.redirect(302,"/");const o=e.query.code.toString(),s=await client.getAccess(o);t.cookie("discordToken",s).redirect("/")})),app.get("/auth/logout",((e,t)=>{t.clearCookie("discordToken",void 0),t.redirect(302,"/")})),app.post("/vote/ibl",(async(t,o)=>{if(t.header("Authorization")!==process.env.VOTE_AUTH)return t.cookies.get("discordToken")?o.sendStatus(403):o.sendStatus(401);const{userID:s}=t.body,i=await e.users.fetch(s),n=(new MessageEmbed).setTitle("New Vote!").setURL("https://infinitybotlist.com/bots/804605929944645672").setDescription(`Thank you, ${i.tag}, for voting for Tanaka in Infinity Bot List!`).setColor("RANDOM").setFooter("infinitybotlist.com").setTimestamp();await hook.send(n),o.sendStatus(201)})),app.listen(port,(()=>e.logger.info(`Listening on localhost:${port}`)))};
//# sourceMappingURL=index.js.map
